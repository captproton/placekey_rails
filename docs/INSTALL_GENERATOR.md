# PlacekeyRails Install Generator

The PlacekeyRails gem includes a powerful install generator that automates the setup process. This guide explains how to use the generator and its available options.

## Basic Usage

After adding the gem to your Gemfile and running `bundle install`, you can use the generator to quickly set up the gem:

```bash
rails generate placekey_rails:install
```

This command will:

1. Create an initializer at `config/initializers/placekey_rails.rb` using Rails credentials for secure API key storage
2. Create a migration to add a `placekey` column to a `location` model (or create the model if it doesn't exist)
3. Update the model to include the `Placekeyable` concern
4. Set up JavaScript integration

After running the generator, don't forget to apply the migration:

```bash
rails db:migrate
```

## API Key Security

By default, the generator sets up the initializer to use Rails credentials for storing your API key securely. It will prompt you to add your key to your credentials file using:

```bash
rails credentials:edit
```

Then add to your credentials file:

```yaml
placekey:
  api_key: your_api_key_here
```

### Using Environment Variables with dotenv

If you prefer to use environment variables with dotenv, you can use the `--use_dotenv` option:

```bash
rails generate placekey_rails:install --use_dotenv
```

This will:
- Create a `.env` file (if it doesn't exist) with a placeholder for your API key
- Create a `.env.example` file for documentation
- Generate an initializer that uses `ENV["PLACEKEY_API_KEY"]`

Make sure to add the dotenv-rails gem to your Gemfile:

```ruby
gem 'dotenv-rails', groups: [:development, :test, :production]
```

And then run `bundle install`.

### Directly Specifying API Key (Not Recommended)

You can also directly specify your API key with the generator, though this is not recommended for production use as it stores the key in plain text:

```bash
rails generate placekey_rails:install --api_key=your_api_key_here
```

## Generator Options

The generator accepts several options to customize the installation:

### `--use_dotenv`

Configure to use environment variables with dotenv instead of Rails credentials:

```bash
rails generate placekey_rails:install --use_dotenv
```

### `--model=NAME`

Specify a different model name (default is 'location'):

```bash
rails generate placekey_rails:install --model=venue
```

This will:
- Create or update a `Venue` model
- Create a migration for the `venues` table
- Add the `Placekeyable` concern to the `Venue` model

### `--skip_initializer`

Skip creating the initializer file:

```bash
rails generate placekey_rails:install --skip_initializer
```

Use this if you want to configure the gem manually or already have an initializer.

### `--skip_migration`

Skip creating the migration file:

```bash
rails generate placekey_rails:install --skip_migration
```

Use this if you already have a `placekey` column in your model or want to add it manually.

### `--skip_model`

Skip modifying the model file:

```bash
rails generate placekey_rails:install --skip_model
```

Use this if you want to manually add the `Placekeyable` concern to your model.

### `--skip_javascript`

Skip setting up JavaScript integration:

```bash
rails generate placekey_rails:install --skip_javascript
```

Use this if you don't need the JavaScript components or want to set them up manually.

## Examples

### Minimal Setup with Rails Credentials

```bash
rails generate placekey_rails:install
```

Then add your API key to credentials:

```bash
rails credentials:edit
```

### Using dotenv with a Custom Model

```bash
rails generate placekey_rails:install --model=store --use_dotenv
```

### API-Only Setup (No Model or JavaScript)

```bash
rails generate placekey_rails:install --skip_model --skip_migration --skip_javascript
```

### Multiple Models

You can run the generator multiple times with different model names:

```bash
rails generate placekey_rails:install
rails generate placekey_rails:install --model=venue --skip_initializer
rails generate placekey_rails:install --model=attraction --skip_initializer
```

## Generated Files

### Initializer with Rails Credentials (Default)

```ruby
# config/initializers/placekey_rails.rb
# PlacekeyRails Configuration
# Generated by PlacekeyRails install generator

# Using Rails credentials for secure API key storage
# Add your key to credentials with: rails credentials:edit
# Format:
# placekey:
#   api_key: your_key_here
PlacekeyRails.setup_client(Rails.application.credentials.dig(:placekey, :api_key))

# Enable caching to improve performance (recommended)
PlacekeyRails.enable_caching(max_size: 1000)

# Configure other options
PlacekeyRails.configure do |config|
  # Default country code for address lookups
  config[:default_country_code] = "US"
  
  # Validate placekeys on assignment (recommended)
  config[:validate_placekeys] = true
  
  # API request timeout in seconds
  config[:api_timeout] = 10
  
  # Whether to raise exceptions on API errors
  config[:raise_on_api_error] = false
end
```

### Migration

For an existing model:

```ruby
class AddPlacekeyToLocations < ActiveRecord::Migration[7.0]
  def change
    add_column :locations, :placekey, :string
    add_index :locations, :placekey
  end
end
```

For a new model:

```ruby
class CreateLocations < ActiveRecord::Migration[7.0]
  def change
    create_table :locations do |t|
      t.string :name
      t.text :description
      t.string :street_address
      t.string :city
      t.string :region
      t.string :postal_code
      t.string :iso_country_code
      t.float :latitude
      t.float :longitude
      t.string :placekey
      t.boolean :featured, default: false

      t.timestamps
    end
    
    add_index :locations, :placekey
    add_index :locations, [:latitude, :longitude]
  end
end
```

### Model

The generator simply adds one line to your model (or creates a new model with this line):

```ruby
include PlacekeyRails::Concerns::Placekeable
```

This enables the Placekeyable concern, which adds methods for working with Placekeys.

## Troubleshooting

### Rails Credentials Issues

If you're having issues with Rails credentials, you can:
1. Make sure your master key is set up correctly in `config/master.key` or the `RAILS_MASTER_KEY` environment variable
2. Check that you've added the placekey section to your credentials with the right format
3. Try switching to dotenv with `--use_dotenv` instead

### dotenv Issues

If you're using dotenv and having issues:
1. Ensure the `dotenv-rails` gem is installed
2. Check that your `.env` file is in the root of your Rails application
3. Verify that `PLACEKEY_API_KEY` is set correctly in your `.env` file
4. Restart your Rails server after changing the `.env` file

### Missing JavaScript Functionality

If the JavaScript components aren't working:
1. Check that the import statement was added to your main JavaScript file
2. Verify that your Rails application is properly configured to use JavaScript (jsbundling-rails, importmaps-rails, or webpacker)
3. Restart your Rails server and rebuild your JavaScript assets

## Next Steps

After running the generator:

1. Run migrations with `rails db:migrate`
2. Configure your API key in credentials or .env file
3. Explore the PlacekeyRails API in the [API Reference](API_REFERENCE.md)
4. Learn about ActiveRecord integration in [ActiveRecord Integration](ACTIVERECORD_INTEGRATION.md)
